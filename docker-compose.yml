version: "3.9"

services:
  web:
    # Build from the provided Dockerfile (production image with precompiled assets)
    build: .
    image: miniportfolio:latest

    # Rails runs in production inside the image; provide master key at runtime
    environment:
      RAILS_ENV: production
      RAILS_MASTER_KEY: ${RAILS_MASTER_KEY}
      RAILS_LOG_LEVEL: info

    # Expose HTTP on host :8080 -> container :80 (Dockerfile EXPOSE 80)
    ports:
      - "8080:80"

    # Persist SQLite DB and Active Storage files between deploys
    # Create this directory on the host with correct ownership before first run:
    #   sudo mkdir -p /var/lib/miniportfolio/storage
    #   sudo chown 1000:1000 /var/lib/miniportfolio/storage
    volumes:
      - /var/lib/miniportfolio/storage:/rails/storage

    # Restart policy suitable for servers
    restart: unless-stopped

    # Liveness check hits Rails health endpoint
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/up || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5

